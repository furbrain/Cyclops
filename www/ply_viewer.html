<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>PLY Viewer (Three.js r160)</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #111;
        }
        canvas {
            display: block;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.160.0/build/three.module.js"
  }
}
</script>

</head>
<body>

<script type="module">
import * as THREE from "three";
import { OrbitControls } from "https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js";
import { PLYLoader } from "https://unpkg.com/three@0.160.0/examples/jsm/loaders/PLYLoader.js";

// viewer code goes here...
console.log("three.js loaded", THREE);

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x111111);

// Camera
const camera = new THREE.PerspectiveCamera(
    60,
    window.innerWidth / window.innerHeight,
    0.1,
    1000
);
camera.position.x = -5;
camera.position.y = -5;
camera.position.z = 2;

// Renderer
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
// renderer.outputEncoding = THREE.sRGBEncoding;
// renderer.outputColorSpace = THREE.SRGBColorSpace;
// renderer.toneMapping = THREE.ACESFilmicToneMapping;
// renderer.toneMappingExposure = 1.0;
document.body.appendChild(renderer.domElement);

// Controls
const controls = new OrbitControls(camera, renderer.domElement);
//const light = new THREE.HemisphereLight(0xffffff, 0x444444, 1.2);
//scene.add(light);

// Lighting
const light1 = new THREE.DirectionalLight(0xffffff, 0.6);
light1.position.set(1, 2, 1);
scene.add(light1);

const light2 = new THREE.AmbientLight(0xffffff, 0.8);
scene.add(light2);

// Load PLY
const loader = new PLYLoader();
loader.load('/ply/current/map_1/scene_dense_texture.ply', (geometry) => {

    geometry.computeVertexNormals();
    console.log(geometry.attributes);

    // Load texture referenced in PLY header
    const texture = new THREE.TextureLoader().load(
        '/ply/current/map_1/scene_dense_texture0.png'
    );
    texture.flipY = true; // critical for GLTF-style UVs
    texture.colorSpace = THREE.SRGBColorSpace;

    const material = new THREE.MeshStandardMaterial({
        map: texture,
        metalness: 0.2,
        roughness: 0.8
    });

    const mesh = new THREE.Mesh(geometry, material);

    geometry.center();
    mesh.scale.set(1, 1, 1);

    scene.add(mesh);
});

// Resize handling
window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});

// Render loop
function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
}
animate();
</script>

</body>
</html>
